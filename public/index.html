<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlÃ¶f Game â€” MVP</title>
  <style>
    body{margin:0;background:#121212;color:#eee;font-family:system-ui, sans-serif;}
    header{background:#1e1e1e;padding:10px;font-weight:600;}
    main{padding:16px;max-width:960px;margin:0 auto;display:grid;gap:16px;}
    .card{background:#1e1e1e;border:1px solid #333;border-radius:10px;padding:12px;}
    label{display:block;margin-bottom:6px;font-size:14px;}
    input,select{width:100%;padding:8px;border-radius:6px;border:1px solid #444;background:#111;color:#eee;}
    button{background:#2f2f2f;color:#eee;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    .row{display:flex;gap:8px;flex-wrap:wrap;}
    .pill{background:#2a2a2a;border:1px solid #444;border-radius:999px;padding:4px 10px;font-size:12px;}
    ul{list-style:none;padding:0;margin:0;display:grid;gap:6px;}
    .hand{display:flex;gap:8px;flex-wrap:wrap;}
    .hand-card{padding:8px 10px;border:1px solid #444;border-radius:6px;background:#151515;cursor:pointer;user-select:none;}
    .hand-card.selected{outline:2px solid #5bc0ff;}
    .muted{opacity:.7;font-size:12px;}
  </style>
</head>
<body>
  <header>BlÃ¶f Game â€” Multiplayer MVP</header>
  <main>
    <section class="card">
      <div class="row">
        <div style="flex:1;min-width:200px;">
          <label>Ä°smin</label>
          <input id="name" placeholder="Player" />
        </div>
        <div style="flex:1;min-width:200px;">
          <label>Oda Kodu</label>
          <input id="room" placeholder="ABCDE" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="create">Oda OluÅŸtur</button>
        <button id="join">Odaya KatÄ±l</button>
        <button id="leave" disabled>Odadan Ã‡Ä±k</button>
        <button id="start" disabled>Oyunu BaÅŸlat</button>
      </div>
      <div id="status" style="margin-top:10px;font-size:14px;"></div>
      <div id="roomInfo" style="margin-top:6px;" class="row"></div>
    </section>

    <section class="card">
      <h3>Oyuncular</h3> 
      <ul id="players"></ul>
      <small class="muted">Maksimum 5 kiÅŸi.</small>
    </section>

    <section class="card">
      <h3>Oyun Durumu</h3>
      <div class="row" id="gameState"></div>
      <div id="lastClaim" class="muted"></div>
      <div id="winner" style="margin-top:8px;"></div>
    </section>

    <section class="card">
      <h3>Elin</h3>
      <div id="hand" class="hand"></div>
      <div class="row" style="margin-top:8px;">
        <div style="min-width:200px;">
          <label>Beyan</label>
          <select id="claim"></select>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px;">
          <button id="play">Beyan Et (1-3 kart)</button>
          <button id="accept">Ä°nan</button>
          <button id="challenge">BlÃ¶f!</button>
        </div>
      </div>
      <div class="muted" id="hint"></div>
    </section>
  </main>

  <script>
    const RANKS = ["2","3","4","5","6","7","8","9","10","J","Q","K","A"];
    const statusEl = document.getElementById("status");
    const playersEl = document.getElementById("players");
    const roomInfoEl = document.getElementById("roomInfo");
    const createBtn = document.getElementById("create");
    const joinBtn = document.getElementById("join");
    const leaveBtn = document.getElementById("leave");
    const startBtn = document.getElementById("start");
    const nameInput = document.getElementById("name");
    const roomInput = document.getElementById("room");
    const handEl = document.getElementById("hand");
    const claimSel = document.getElementById("claim");
    const playBtn = document.getElementById("play");
    const acceptBtn = document.getElementById("accept");
    const challengeBtn = document.getElementById("challenge");
    const gameStateEl = document.getElementById("gameState");
    const lastClaimEl = document.getElementById("lastClaim");
    const hintEl = document.getElementById("hint");
    const winnerEl = document.getElementById("winner");

    RANKS.forEach(r => {
      const o = document.createElement("option");
      o.value = r; o.textContent = r;
      claimSel.appendChild(o);
    });

    const ws = new WebSocket(`${location.origin.replace("http", "ws")}/ws`);
    let clientId = null;
    let currentRoom = null;
    let roomState = null;
    let hand = [];
    let selected = new Set();

    function setStatus(msg) { statusEl.textContent = msg; }

    function renderPlayers(players) {
      playersEl.innerHTML = "";
      players.forEach((p) => {
        const li = document.createElement("li");
        li.textContent = `${p.name}${p.id === clientId ? " (sen)" : ""}`;
        playersEl.appendChild(li);
      });
    }

    function renderRoomInfo(roomId, players, maxPlayers) {
      roomInfoEl.innerHTML = "";
      if (!roomId) return;
      const pill1 = document.createElement("span");
      pill1.className = "pill";
      pill1.textContent = `Oda: ${roomId}`;
      const pill2 = document.createElement("span");
      pill2.className = "pill";
      pill2.textContent = `Oyuncu: ${players.length}/${maxPlayers}`;
      roomInfoEl.appendChild(pill1);
      roomInfoEl.appendChild(pill2);
    }

    function renderHand() {
      handEl.innerHTML = "";
      hand.forEach((c) => {
        const div = document.createElement("div");
        div.className = "hand-card" + (selected.has(c.id) ? " selected" : "");
        div.textContent = c.rank + c.suit;
        div.onclick = () => {
          if (selected.has(c.id)) selected.delete(c.id);
          else if (selected.size < 3) selected.add(c.id);
          renderHand();
        };
        handEl.appendChild(div);
      });
    }

    function renderState() {
      if (!roomState) return;
      renderPlayers(roomState.players);
      renderRoomInfo(roomState.roomId, roomState.players, roomState.maxPlayers);
      gameStateEl.innerHTML = "";
      const pills = [
        `Durum: ${roomState.status}`,
        `SÄ±ra: ${nameById(roomState.turnPlayerId) || "-"}`,
        `Pile: ${roomState.pileCount}`
      ];
      pills.forEach((t) => { const s = document.createElement("span"); s.className = "pill"; s.textContent = t; gameStateEl.appendChild(s); });
      lastClaimEl.textContent = roomState.lastClaimRank ? `Son beyan: ${roomState.lastClaimRank}` : "Son beyan: -";

      const isHost = roomState.hostId === clientId;
      startBtn.disabled = !(isHost && roomState.status === "waiting" && roomState.players.length >= 2);

      if (roomState.winnerId) {
        winnerEl.textContent = `ðŸ Kazanan: ${nameById(roomState.winnerId)}`;
      } else {
        winnerEl.textContent = "";
      }

      const myTurn = roomState.turnPlayerId === clientId;
      const awaiting = roomState.awaitingChallenge;
      const iPlayed = roomState.lastPlayBy === clientId;

      playBtn.disabled = !(myTurn && !awaiting && selected.size >= 1);
      acceptBtn.disabled = !(awaiting && !iPlayed);
      challengeBtn.disabled = !(awaiting && !iPlayed);

      hintEl.textContent = myTurn ? "Sende sÄ±ra â€” 1-3 kart seÃ§ip beyan et." : "SÄ±ra rakipte.";
      if (awaiting && !iPlayed) hintEl.textContent = "Beyan yapÄ±ldÄ± â€” inanabilir veya blÃ¶f diyebilirsin.";
      if (awaiting && iPlayed) hintEl.textContent = "Beyan yaptÄ±n â€” biri blÃ¶f diyebilir.";
    }

    function nameById(id) {
      const p = roomState?.players?.find(p => p.id === id);
      return p ? p.name : id;
    }

    ws.onopen = () => setStatus("BaÄŸlandÄ± âœ…");
    ws.onclose = () => setStatus("BaÄŸlantÄ± kesildi âŒ");

    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === "hello") clientId = msg.clientId;
      if (msg.type === "joined") {
        currentRoom = msg.roomId;
        leaveBtn.disabled = false;
        setStatus(`Odaya katÄ±ldÄ±n: ${msg.roomId}`);
      }
      if (msg.type === "room_state") {
        roomState = msg;
        renderState();
      }
      if (msg.type === "hand") {
        hand = msg.hand || [];
        selected.clear();
        renderHand();
      }
      if (msg.type === "challenge_result") {
        const ok = msg.truthful ? "DOÄžRU" : "BLÃ–F";
        setStatus(`Beyan ${ok}. Kazanan: ${nameById(msg.winnerId)}`);
      }
      if (msg.type === "error") setStatus(`Hata: ${msg.message}`);
    };

    createBtn.onclick = () => {
      ws.send(JSON.stringify({ type: "create_room", name: nameInput.value || "Player" }));
    };

    joinBtn.onclick = () => {
      const roomId = (roomInput.value || "").toUpperCase().trim();
      if (!roomId) return setStatus("Oda kodu girin");
      ws.send(JSON.stringify({ type: "join_room", roomId, name: nameInput.value || "Player" }));
    };

    leaveBtn.onclick = () => {
      ws.send(JSON.stringify({ type: "leave_room" }));
      currentRoom = null;
      leaveBtn.disabled = true;
      renderPlayers([]);
      renderRoomInfo(null, [], 0);
      setStatus("Odadan Ã§Ä±ktÄ±n");
    };

    startBtn.onclick = () => {
      ws.send(JSON.stringify({ type: "start_game" }));
    };

    playBtn.onclick = () => {
      const cards = Array.from(selected);
      if (cards.length < 1 || cards.length > 3) return;
      ws.send(JSON.stringify({ type: "play", cards, claimRank: claimSel.value }));
    };

    acceptBtn.onclick = () => {
      ws.send(JSON.stringify({ type: "accept" }));
    };

    challengeBtn.onclick = () => {
      ws.send(JSON.stringify({ type: "challenge" }));
    };
  </script>
</body>
</html>
